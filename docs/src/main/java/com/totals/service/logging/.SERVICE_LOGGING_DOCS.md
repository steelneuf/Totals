# Service/Logging Map Documentatie - BA Totalisatie Spring Boot Applicatie

## Overzicht van de Service/Logging Map

De `service/logging/` map bevat alle logging services voor de BA Totalisatie Spring Boot applicatie. Deze services zijn verantwoordelijk voor het lezen, parsen en filteren van log bestanden.

**Locatie**: `src/main/java/com/totals/service/logging/`

**Aantal bestanden**: 1 bestand

---

## Folder Structuur

```
service/logging/
├── LogService.java        # Log file processing service
└── .SERVICE_LOGGING_DOCS.md # Deze documentatie
```

## Bestanden in de Service/Logging Map

### LogService.java

**Doel**: Service voor het lezen en parsen van log bestanden met JSON format en kenmerk filtering.

**Package**: `com.totals.service.logging`

**Annotaties**:
- `@Service`: Spring annotatie die deze klasse markeert als een service component

**Attributen**:
| Naam | Type | Beschrijving |
|------|------|--------------|
| `KENMERK_PATTERN` | `Pattern` | Regex pattern voor kenmerk extractie uit log regels |
| `logFilePath` | `Path` | Log file path (constructed in constructor) |
| `objectMapper` | `ObjectMapper` | Jackson JSON parser voor log parsing |

**Constructor**:
```java
public LogService(
    @Value("${logging.path:./logs}") String logPath,
    @Value("${logging.calculation.filename:ba-calc.log}") String calculationLogFile)
```

**Dependency Injection**: Constructor injection met default values via @Value annotaties

**Methoden**:

#### getLogsForKenmerk(String kenmerk, int last)
```java
public List<BaLogEntry> getLogsForKenmerk(String kenmerk, int last) throws IOException
```

**Parameters:**
- `kenmerk` (String): Kenmerk voor log filtering
- `last` (int): Aantal laatste entries (1-1000)

**Functionaliteit:**
1. Controleert of log file bestaat via `Files.exists(logFilePath)`
2. Parseert log file en filtert op kenmerk via `Files.lines()` stream
3. Filtert regels op kenmerk via regex pattern matching
4. Neemt laatste N entries via `subList()`
5. Parseert regels naar BaLogEntry objects via JSON parsing
6. Retourneert laatste N entries

**Return Type**: `List<BaLogEntry>`

**Exceptions**: `IOException` als log file niet bestaat of niet leesbaar is






**Dependencies:**
- Jackson ObjectMapper: Voor JSON parsing
- Spring @Value: Voor property injection
- Java NIO: Voor file I/O operaties

**Gebruik in Applicatie**: Wordt gebruikt door `LogsController` voor het ophalen van log data.

---

## Samenwerking tussen Componenten

### Log Processing Flow
```
LogsController
    ↓
LogService.getLogsForKenmerk()
    ↓
File I/O (Java NIO)
    ↓
JSON Parsing (Jackson)
    ↓
BaLogEntry DTOs
    ↓
BaLogsResponse
```

### Data Flow
1. **Request**: Controller ontvangt kenmerk en aantal entries
2. **Validation**: Input validatie voor kenmerk en range
3. **File Reading**: Log file lezen via Java NIO
4. **Filtering**: Regels filteren op kenmerk via regex
5. **Parsing**: JSON parsing naar BaLogEntry objects
6. **Response**: Retourneren van gefilterde log entries

## Log File Format

### JSON Log Format
```json
{
  "@timestamp": "2024-01-15T10:30:45.123Z",
  "level": "INFO",
  "message": "Calculation started for kenmerk: ABC123",
  "kenmerk": "ABC123"
}
```

### Kenmerk Extractie
- **Pattern**: `kenmerk[=:]\\s*(\\S+)`
- **Matches**: "kenmerk=ABC123" of "kenmerk: ABC123"
- **Capture Group**: De waarde na "=" of ":"

## File I/O Operations

### Java NIO Files API
- **Files.lines()**: Stream-based file reading
- **Files.exists()**: File existence check
- **Files.isReadable()**: File readability check
- **Try-with-resources**: Automatic resource management

### Path Construction
```java
Path logFilePath = Paths.get(logPath, calculationLogFile);
// Result: ./logs/ba-calc.log (default)
```

## JSON Parsing Strategy

### Jackson ObjectMapper
- **readTree()**: Parse JSON string naar JsonNode
- **get()**: Field access via field name
- **asText()**: Convert naar String

### Error Handling
- **Corrupt Lines**: Skip zonder crash
- **Missing Fields**: Return lege string
- **Invalid JSON**: Exception handling per regel

## Performance Overwegingen

### Memory Management
- **Stream Processing**: Files.lines() voor memory efficiency
- **Filtering**: Stream filter voor early filtering
- **SubList**: Alleen laatste N entries in memory

### File I/O
- **Single Read**: Leest hele file in één keer
- **No Caching**: Geen file caching (stateless service)
- **Error Recovery**: Graceful handling van corrupte regels

## Configuration Properties

### Injected Properties
- **logging.path**: Log directory (default: ./logs)
- **logging.calculation.filename**: Log filename (default: ba-calc.log)

### Environment Variable Support
- **LOG_PATH**: Override voor log directory
- **LOG_CALC_FILENAME**: Override voor log filename

## Error Handling Strategy

### Input Validation
- **IllegalArgumentException**: Voor invalid input parameters
- **Range Validation**: 1-1000 entries limit

### File I/O Errors
- **IOException**: Voor file niet gevonden of niet leesbaar
- **File Existence**: Controleert file existence vooraf

### JSON Parsing Errors
- **Exception Handling**: Per regel, skip corrupte regels
- **Graceful Degradation**: Service blijft functioneren

## Best Practices Geïmplementeerd

1. **Resource Management**: Try-with-resources voor file streams
2. **Error Handling**: Graceful handling van corrupte data
3. **Input Validation**: Uitgebreide input validatie
4. **Configuration**: Externalized configuration via properties
5. **Memory Efficiency**: Stream processing voor grote files
6. **Null Safety**: Defensive programming voor missing fields

## Troubleshooting

### Veelvoorkomende Problemen

1. **File Not Found**: Controleer logging.path configuratie
2. **Permission Denied**: Controleer file permissions
3. **JSON Parse Errors**: Controleer log file format
4. **Empty Results**: Controleer kenmerk pattern matching

### Debug Tips

- Controleer log file path via application.properties
- Test kenmerk pattern met regex tester
- Valideer JSON format van log entries
- Controleer file permissions en accessibility
