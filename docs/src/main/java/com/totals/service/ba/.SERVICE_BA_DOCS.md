# Service/BA Map Documentatie - BA Totalisatie Spring Boot Applicatie

## Overzicht van de Service/BA Map

De `service/ba/` map bevat alle business logic services voor de BA Totalisatie Spring Boot applicatie. Deze services implementeren de kern business logica voor BA berekeningen, validatie en orchestratie.

**Locatie**: `src/main/java/com/totals/service/ba/`

**Aantal bestanden**: 3 bestanden

---

## Folder Structuur

```
service/ba/
├── BaCalculator.java    # Pure berekening logica
├── BaService.java       # Service orchestrator
├── BaValidator.java     # Input validatie service
└── .SERVICE_BA_DOCS.md # Deze documentatie
```

## Bestanden in de Service/BA Map

### BaCalculator.java

**Doel**: Pure business logic component voor BA berekeningen zonder dependencies op Spring of database.

**Package**: `com.totals.service.ba`

**Annotaties**:
- `@Component`: Spring annotatie die deze klasse markeert als een Spring component

**Attributen**: Geen

**Methoden**:

#### performCalculations(BaTotalsResponse agg, Integer percentage)
```java
public BaTotalRecord performCalculations(BaTotalsResponse agg, Integer percentage)
```

**Parameters:**
- `agg` (BaTotalsResponse): Geaggregeerde data uit database
- `percentage` (Integer): Bijdrage percentage (1-100)

**Functionaliteit:**
1. Converteert percentage naar decimal (percentage / 100.0)
2. Berekent cijfer7 = agg.totaal1()
3. Berekent cijfer1 via `calculateCijfer1()` helper methode
4. Berekent totaal1 = cijfer1
5. Berekent totaal2 = (agg.totaal3() / cijfer7) * cijfer1
6. Berekent totaal3 = (agg.totaal4() / cijfer7) * cijfer1
7. Berekent totaal4 = agg.totaal5() * bijdrage
8. Berekent totaal5 = agg.totaal6()
9. Creëert en vult BaTotalRecord met berekende waarden

**Return Type**: `BaTotalRecord`

**Berekening Formules:**
- **cijfer1**: `min(totaal1, totaal2 / bijdrage)`
- **totaal1**: `cijfer1`
- **totaal2**: `(totaal3 / cijfer7) * cijfer1`
- **totaal3**: `(totaal4 / cijfer7) * cijfer1`
- **totaal4**: `totaal5 * bijdrage`
- **totaal5**: `totaal6`

#### calculateCijfer1(double totaal1, double totaal2, double bijdrage)
```java
public double calculateCijfer1(double totaal1, double totaal2, double bijdrage)
```

**Parameters:**
- `totaal1` (double): Eerste totaal waarde
- `totaal2` (double): Tweede totaal waarde
- `bijdrage` (double): Bijdrage als decimal (0.0-1.0)

**Functionaliteit:**
1. Berekent threshold = totaal2 / bijdrage
2. Retourneert minimum van totaal1 en threshold

**Return Type**: `double`

**Business Rule**: Cijfer1 mag niet groter zijn dan de threshold waarde

**Dependencies:**
- `BaTotalsResponse`: Voor input data
- `BaTotalRecord`: Voor output data

**Gebruik in Applicatie**: Wordt gebruikt door `BaService` voor het uitvoeren van de kern BA berekeningen.

---

### BaService.java

**Doel**: Hoofdservice die BA berekeningen orchestreert en alle dependencies coördineert.

**Package**: `com.totals.service.ba`

**Annotaties**:
- `@Service`: Spring annotatie die deze klasse markeert als een service component

**Attributen**:
| Naam | Type | Beschrijving |
|------|------|--------------|
| `logger` | `Logger` | SLF4J logger instance voor logging |
| `recordRepository` | `BaRecordRepository` | Repository voor BA records |
| `totalRepository` | `BaTotalRepository` | Repository voor berekende totalen |
| `baValidator` | `BaValidator` | Service voor input validatie |
| `baCalculator` | `BaCalculator` | Service voor berekeningen |

**Constructor**:
```java
public BaService(BaRecordRepository recordRepository, BaTotalRepository totalRepository, 
                 BaValidator baValidator, BaCalculator baCalculator)
```

**Dependency Injection**: Constructor injection van alle dependencies voor immutable state

**Methoden**:

#### calculateTotals(String kenmerk, Integer bijdragePercentage, LocalDateTime requestTime)
```java
@Transactional
public BaTotalRecord calculateTotals(String kenmerk, Integer bijdragePercentage, LocalDateTime requestTime)
```

**Parameters:**
- `kenmerk` (String): Unieke identifier voor de berekening
- `bijdragePercentage` (Integer): Bijdrage percentage (1-100)
- `requestTime` (LocalDateTime): Request timestamp voor optimistic locking

**Functionaliteit:**
1. Valideert inputs via `baValidator.validateInputs()`
2. Haalt geaggregeerde data op via `recordRepository.calculateTotalsByKenmerk()`
3. Valideert divisor (geen division by zero) via `baValidator.validateDivisor()`
4. Voert berekeningen uit via `baCalculator.performCalculations()`
5. Slaat/update totaal op via `saveOrUpdateTotal()`

**Return Type**: `BaTotalRecord`


#### saveOrUpdateTotal(String kenmerk, BaTotalRecord calculated, LocalDateTime requestTime)
```java
@Transactional
public BaTotalRecord saveOrUpdateTotal(String kenmerk, BaTotalRecord calculated, LocalDateTime requestTime)
```

**Parameters:**
- `kenmerk` (String): Kenmerk voor het record
- `calculated` (BaTotalRecord): Berekende totalen
- `requestTime` (LocalDateTime): Request timestamp

**Functionaliteit:**
1. Converteert timestamp naar epoch milliseconds
2. Probeert update via `totalRepository.updateIfNewer()`
3. Als update succesvol: haalt geüpdatete record op
4. Als geen update: controleert of record bestaat
5. Als bestaat: logt warning en returnt bestaande
6. Als niet bestaat: creëert nieuw record

**Return Type**: `BaTotalRecord`

#### createNewTotal(String kenmerk, BaTotalRecord source)
```java
private BaTotalRecord createNewTotal(String kenmerk, BaTotalRecord source)
```

**Parameters:**
- `kenmerk` (String): Kenmerk voor het nieuwe record
- `source` (BaTotalRecord): Source record met waarden

**Functionaliteit:**
1. Creëert nieuw BaTotalRecord object
2. Kopieert kenmerk en alle totaal waarden
3. Retourneert nieuw record

**Return Type**: `BaTotalRecord`

**Dependencies:**
- `BaRecordRepository`, `BaTotalRepository`: Voor data access
- `BaValidator`, `BaCalculator`: Voor business logic
- SLF4J Logger: Voor logging
- Spring Retry, Transaction, Web: Voor framework features

**Gebruik in Applicatie**: Wordt gebruikt door `BaController` als hoofdbusiness service.

---

### BaValidator.java

**Doel**: Centraliseert input validatie voor BA service met configurable validation rules.

**Package**: `com.totals.service.ba`

**Annotaties**:
- `@Component`: Spring annotatie die deze klasse markeert als een Spring component

**Attributen**:
| Naam | Type | Beschrijving |
|------|------|--------------|
| `logger` | `Logger` | SLF4J logger instance voor logging |

**Constructor**: Geen (default constructor)

**Methoden**:

#### validateInputs(String kenmerk, Integer bijdragePercentage)
```java
public void validateInputs(String kenmerk, Integer bijdragePercentage)
```

**Parameters:**
- `kenmerk` (String): Te valideren kenmerk
- `bijdragePercentage` (Integer): Te valideren percentage

**Functionaliteit:**
1. Valideert kenmerk: null/empty check, lengte (1-50), regex pattern
2. Valideert bijdragePercentage: null check, range (1-100)
3. Gooit IllegalArgumentException bij fouten

**Validation Rules**:
- **Kenmerk**: Niet leeg, lengte 1-50, alleen letters/cijfers/underscores/streepjes
- **BijdragePercentage**: Niet null, range 1-100

#### validateDivisor(double value, String kenmerk)
```java
public void validateDivisor(double value, String kenmerk)
```

**Parameters:**
- `value` (double): Te valideren waarde
- `kenmerk` (String): Kenmerk voor error message

**Functionaliteit:**
1. Controleert op division by zero
2. Gooit ResponseStatusException (422) als waarde 0

**HTTP Status**: 422 Unprocessable Entity

**Dependencies:**
- Spring Web: Voor ResponseStatusException
- SLF4J Logger: Voor logging

**Gebruik in Applicatie**: Wordt gebruikt door `BaService` voor input validatie.

---

## Samenwerking tussen Componenten

### Service Orchestration Flow
```
BaService (Orchestrator)
    ↓
BaValidator (Input Validation)
    ↓
BaRecordRepository (Data Retrieval)
    ↓
BaCalculator (Business Logic)
    ↓
BaTotalRepository (Data Persistence)
```

### Business Logic Flow
1. **Input Validation**: `BaValidator` valideert alle inputs
2. **Data Retrieval**: `BaService` haalt geaggregeerde data op
3. **Divisor Validation**: `BaValidator` controleert op division by zero
4. **Calculation**: `BaCalculator` voert berekeningen uit
5. **Data Persistence**: `BaService` slaat resultaten op

### Error Handling Strategy
- **Validation Errors**: IllegalArgumentException (400 Bad Request)
- **Data Errors**: ResponseStatusException (404 Not Found)
- **Calculation Errors**: ResponseStatusException (422 Unprocessable Entity)

## Business Rules en Formules

### BA Berekening Formules

#### Cijfer1 Berekening
```
cijfer1 = min(totaal1, totaal2 / bijdrage)
```
**Business Rule**: Cijfer1 mag niet groter zijn dan de threshold waarde

#### Totaal Berekeningen
```
totaal1 = cijfer1
totaal2 = (totaal3 / cijfer7) * cijfer1
totaal3 = (totaal4 / cijfer7) * cijfer1
totaal4 = totaal5 * bijdrage
totaal5 = totaal6
```

#### Divisor Validatie
```
cijfer7 = totaal1 (mag niet 0 zijn)
```

### Validation Rules

#### Kenmerk Validatie
- **Not Null/Empty**: Verplicht veld
- **Length**: 1-50 karakters (configurable)
- **Pattern**: Alleen letters, cijfers, underscores en streepjes (configurable)

#### Bijdrage Percentage Validatie
- **Not Null**: Verplicht veld
- **Range**: 1-100 (configurable)

## Optimistic Locking
- **Timestamp Based**: Via requestTimestamp veld
- **Update Strategy**: Alleen update als nieuwe timestamp ouder is
- **Conflict Resolution**: Log warning en return bestaande waarde

## Performance Overwegingen

### Transaction Management
- **Read-Only**: Repository queries zijn read-only waar mogelijk
- **Write Transactions**: Alleen voor data persistence

### Memory Management
- **Stateless Services**: Alle services zijn stateless
- **Dependency Injection**: Constructor injection voor immutable state
- **Object Creation**: Minimale object creatie in business logic

## Best Practices Geïmplementeerd

1. **Single Responsibility**: Elke service heeft één verantwoordelijkheid
2. **Dependency Injection**: Constructor injection voor testability
3. **Immutable State**: Services zijn stateless
4. **Error Handling**: Gedetailleerde error handling per scenario
5. **Configuration**: Externalized configuration via properties
6. **Logging**: Uitgebreide logging voor debugging

## Troubleshooting

### Veelvoorkomende Problemen

1. **Validation Errors**: Controleer hardcoded validatie regels
2. **Division by Zero**: Controleer totaal1 waarde in database
3. **Transaction Issues**: Controleer @Transactional annotaties

### Debug Tips

- Gebruik logging voor business logic flow tracking
- Test validation rules met verschillende inputs
- Controleer database data voor division by zero scenarios
