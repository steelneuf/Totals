# Controller Map Documentatie - BA Totalisatie Spring Boot Applicatie

## Overzicht van de Controller Map

De `controller/` map bevat alle REST API endpoints van de BA Totalisatie applicatie. Deze controllers fungeren als de presentatie laag en zijn verantwoordelijk voor het afhandelen van HTTP requests en het terugsturen van responses naar clients.

**Locatie**: `src/main/java/com/totals/controller/`

**Aantal bestanden**: 3 controllers

---

## 1. BaController.java

### Doel
De hoofdbusiness controller die verantwoordelijk is voor het berekenen van BA totalen op basis van een kenmerk en bijdragepercentage.

### Annotaties
- `@RestController`: Spring annotatie die de klasse markeert als een REST controller
- `@RequestMapping("/api/${api.version}")`: Basis URL mapping die de API versie uit application.properties gebruikt (v1)
- `@PostMapping("/ba/{kenmerk}/calculate-totals")`: POST endpoint voor het berekenen van totalen
- `@PathVariable`: Voor het extraheren van de kenmerk parameter uit de URL
- `@RequestParam`: Voor het extraheren van het bijdragePercentage parameter uit de query string

### Attributen
- `private static final Logger logger`: SLF4J logger instance voor logging
- `private final BaService baService`: Dependency injection van de BaService voor business logic

### Constructor
```java
public BaController(BaService baService)
```
- **Dependency Injection**: Constructor injection van BaService
- **Immutability**: Final field zorgt voor thread-safe immutable state

### Methoden

#### calculateTotals()
```java
@PostMapping("/ba/{kenmerk}/calculate-totals")
public ResponseEntity<BaCalculationResponse> calculateTotals(
    @PathVariable String kenmerk,
    @RequestParam Integer bijdragePercentage)
```

**Parameters:**
- `kenmerk` (String): Unieke identifier voor de BA berekening
- `bijdragePercentage` (Integer): Percentage waarde tussen 1-100

**Functionaliteit:**
1. **Timing**: Starttijd registreren voor performance monitoring
2. **Request Time**: Huidige timestamp vastleggen
3. **Business Logic**: BaService aanroepen voor berekening
4. **Data Transformation**: BaTotalRecord omzetten naar List<Double>
5. **Performance**: Duur berekenen in milliseconden
6. **Response**: BaCalculationResponse.success() factory method gebruiken

**Return Type**: `ResponseEntity<BaCalculationResponse>`

**Dependencies:**
- `BaService`: Voor business logic uitvoering
- `BaCalculationResponse`: Voor response formatting
- `BaTotalRecord`: Voor data model

**Performance Monitoring:**
- Starttijd: `System.currentTimeMillis()`
- Duur berekening: `duration = System.currentTimeMillis() - startTime`

---

## 2. HealthController.java

### Doel
Health check endpoint voor monitoring en load balancer health checks.

### Annotaties
- `@RestController`: Spring REST controller annotatie
- `@RequestMapping("/api/${api.version}/health")`: Health endpoint mapping
- `@GetMapping`: GET request handler

### Methoden

#### healthCheck()
```java
@GetMapping
public ResponseEntity<Map<String, Object>> healthCheck()
```

**Functionaliteit:**
1. **Status Check**: Service status controleren
2. **Metadata**: Service naam en timestamp toevoegen
3. **Response**: Map met health informatie terugsturen

**Response Data:**
- `status`: "UP" (service is operationeel)
- `service`: "BA Totals API" (service identificatie)
- `timestamp`: Huidige tijd in ISO format

**Return Type**: `ResponseEntity<Map<String, Object>>`

**Gebruik:**
- Load balancer health checks
- Monitoring systemen
- Service discovery
- DevOps monitoring

---

## 3. LogsController.java

### Doel
Controller voor het ophalen van log entries voor een specifiek kenmerk.

### Annotaties
- `@RestController`: Spring REST controller annotatie
- `@RequestMapping("/api/${api.version}/ba/{kenmerk}/logs")`: Logs endpoint met kenmerk parameter
- `@Validated`: Bean validation op class level
- `@GetMapping`: GET request handler
- `@PathVariable`: Voor kenmerk parameter uit URL met validatie
- `@RequestParam`: Voor last parameter met default waarde en validatie

### Attributen
- `private static final Logger logger`: SLF4J logger instance voor logging
- `private final LogService logService`: Dependency injection van LogService

### Constructor
```java
public LogsController(LogService logService)
```
- **Dependency Injection**: Constructor injection van LogService
- **Immutability**: Final field voor thread-safe state

### Methoden

#### getLogsForKenmerk()
```java
@GetMapping
public ResponseEntity<BaLogsResponse> getLogsForKenmerk(
    @PathVariable @NotBlank @Pattern(regexp = "^[a-zA-Z0-9_-]+$") String kenmerk,
    @RequestParam(defaultValue = "${api.validation.logs-default-entries:50}") 
    @Min(value = 1, message = "Aantal entries moet minimaal 1 zijn") 
    @Max(value = 1000, message = "Aantal entries mag maximaal 1000 zijn") int last) 
    throws java.io.IOException
```

**Parameters:**
- `kenmerk` (String): Unieke identifier voor log filtering met validatie:
  - `@NotBlank`: Mag niet leeg zijn
  - `@Pattern(regexp = "^[a-zA-Z0-9_-]+$")`: Alleen letters, cijfers, underscores en streepjes
- `last` (int): Aantal laatste entries met validatie:
  - `@Min(1)`: Minimum 1 entry
  - `@Max(1000)`: Maximum 1000 entries
  - Default: 50 (configureerbaar via properties)

**Default Waarde Configuratie:**
- Property: `api.validation.logs-default-entries`
- Fallback: 50 entries
- Configuratie in `application.properties`

**Functionaliteit:**
1. **Log Retrieval**: LogService aanroepen voor kenmerk-specifieke logs
2. **Response Formatting**: BaLogsResponse.success() factory method
3. **Error Handling**: IOException propagation voor file I/O errors

**Return Type**: `ResponseEntity<BaLogsResponse>`

**Dependencies:**
- `LogService`: Voor log data retrieval
- `BaLogsResponse`: Voor response formatting
- `BaLogEntry`: Voor log entry data model

---

## API Endpoint Overzicht

### Base URL
Alle endpoints gebruiken de base URL: `/api/v1`

### Endpoints

| Method | Endpoint | Controller | Beschrijving |
|--------|----------|------------|--------------|
| POST | `/api/v1/ba/{kenmerk}/calculate-totals?bijdragePercentage={percentage}` | BaController | BA totalen berekenen |
| GET | `/api/v1/health` | HealthController | Service health check |
| GET | `/api/v1/ba/{kenmerk}/logs?last={count}` | LogsController | Logs ophalen voor kenmerk |

### Request/Response Voorbeelden

#### BA Totalen Berekening
```http
POST /api/v1/ba/ABC123/calculate-totals?bijdragePercentage=25
```

**Response:**
```json
{
  "message": "BA totals calculated successfully for kenmerk: ABC123 with bijdragePercentage: 25",
  "kenmerk": "ABC123",
  "bijdragePercentage": 25,
  "totalen": [100.0, 200.0, 300.0, 400.0, 500.0],
  "durationMs": 150
}
```

#### Health Check
```http
GET /api/v1/health
```

**Response:**
```json
{
  "status": "UP",
  "service": "BA Totals API",
  "timestamp": "2024-01-15T10:30:45.123"
}
```

#### Logs Ophalen
```http
GET /api/v1/ba/ABC123/logs?last=10
```

**Response:**
```json
{
  "kenmerk": "ABC123",
  "logEntries": [
    {
      "timestamp": "2024-01-15T10:30:45.123",
      "level": "INFO",
      "message": "Calculation started"
    }
  ]
}
```

---

## Configuratie Dependencies

### Application Properties
De controllers gebruiken de volgende properties uit `application.properties`:

- `api.version`: API versie (v1)

### Environment Variables
De applicatie ondersteunt environment variable overrides:
- `DB_URL`, `DB_USERNAME`, `DB_PASSWORD`: Database configuratie
- `LOG_PATH`, `LOG_LEVEL`: Logging configuratie

---

## Error Handling

### Global Exception Handling
Alle controllers gebruiken de `GlobalExceptionHandler` voor:
- Input validatie errors
- Business logic exceptions
- Database connection errors
- File I/O errors (voor logs)

### Response Status Codes
- `200 OK`: Succesvolle operatie
- `400 Bad Request`: Ongeldige input parameters
- `500 Internal Server Error`: Server-side errors

---

## Performance Kenmerken

### Single-Threaded Configuratie
De applicatie is geconfigureerd voor single-threaded operatie:
- `server.tomcat.threads.max=1`
- `spring.datasource.hikari.maximum-pool-size=1`

### Performance Monitoring
- **Timing**: Alle berekeningen worden getimed
- **Duration Tracking**: Response bevat duur in milliseconden
- **Logging**: Uitgebreide logging voor debugging

---

## Security Overwegingen

### CORS Configuratie
De applicatie gebruikt `CorsConfig` voor cross-origin requests.

### Input Validatie
- Kenmerk validatie via regex pattern
- Bijdragepercentage range validatie (1-100)
- Log entries limit validatie

---

## Samenvatting

De controller map bevat drie gespecialiseerde controllers die samen de complete REST API vormen:

1. **BaController**: Kern business functionaliteit voor BA berekeningen
2. **HealthController**: Monitoring en health checks
3. **LogsController**: Log retrieval en debugging

Alle controllers volgen Spring Boot best practices met:
- Constructor dependency injection
- Immutable state management
- Proper error handling
- Performance monitoring
- Configurable parameters

De API is ontworpen voor single-threaded operatie met uitgebreide logging en monitoring capabilities.
